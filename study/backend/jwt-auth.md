# Express / Prisma ã‚’ç”¨ã„ãŸJWTèªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…

## æ¤œè¨¼ç”¨ãƒªãƒã‚¸ãƒˆãƒª

https://github.com/ykob/learn-nodejs-with-express

## JWTã¨ã¯

JWTã¨ã¯ã€JSON Web Tokenã®ç•¥ã§ã€JSONå½¢å¼ã§æƒ…å ±ã‚’ã‚„ã‚Šå–ã‚Šã™ã‚‹ãŸã‚ã®ä»•æ§˜ã®ã“ã¨ã€‚  
JWTã¨æ›¸ã„ã¦ã‚¸ãƒ§ãƒƒãƒˆã¨èª­ã‚€ã€‚  
JWTã¯RFC 7519ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚

JWTã¯ã€ä»¥ä¸‹ã®3ã¤ã®æ–‡å­—åˆ—ã‚’ãƒ”ãƒªã‚ªãƒ‰ã§åŒºåˆ‡ã£ãŸæ–‡å­—åˆ—ã§è¡¨ã•ã‚Œã‚‹ã€‚

- ãƒ˜ãƒƒãƒ€ãƒ¼
- ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
- ç½²å

## ä½¿ç”¨ã™ã‚‹ç’°å¢ƒ

| Module | Usage |
| --- | --- |
| [Express](https://expressjs.com/ja/) | Node.jsã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒã®æ©Ÿèƒ½å…¨èˆ¬ã®æ§‹ç¯‰ã«åˆ©ç”¨ã™ã‚‹ã€‚ |
| [Prisma](https://www.prisma.io/) | Node.js/TypeScriptç”¨ã®ORMãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹ç¯‰ã¨æ¥ç¶šã«åˆ©ç”¨ã™ã‚‹ã€‚ |
| [bcryptjs](https://www.npmjs.com/package/bcryptjs) | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ãŸã‚Šã€ãƒãƒƒã‚·ãƒ¥å€¤ã¨æ–‡å­—åˆ—ã‚’æ¯”è¼ƒã—ãŸã‚Šã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ |
| [jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken) | JWTã‚’ç™ºè¡Œã—ãŸã‚Šã€JWTã®å€¤ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‹ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ |
| [uuid](https://www.npmjs.com/package/uuid) | UUID(Universally Unique IDentifier)ã‚’ç™ºè¡Œã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ã“ã“ã§ã¯jti(JWT ID)ã«åˆ©ç”¨ã™ã‚‹ã€‚ |

## å‚è€ƒãƒªãƒ³ã‚¯

- [RFC 7519 - JSON Web Token (JWT)](https://datatracker.ietf.org/doc/html/rfc7519)
- [JWT Authentication using Prisma and Express - DEV Community](https://dev.to/mihaiandrei97/jwt-authentication-using-prisma-and-express-37nk)

## æ‰‹é †

- schema.prismaã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± `User` ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ `RefreshToken` ã®ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± `User` ã«é–¢é€£ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã™ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± `User` ã«é–¢é€£ã™ã‚‹APIãƒ«ãƒ¼ãƒˆã‚’å®šç¾©ã™ã‚‹
- èªè¨¼å‡¦ç† `Auth` ã«é–¢é€£ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã™ã‚‹
- èªè¨¼å‡¦ç† `Auth` ã«é–¢é€£ã™ã‚‹APIãƒ«ãƒ¼ãƒˆã‚’å®šç¾©ã™ã‚‹
- èªè¨¼å‡¦ç†ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½œæˆã™ã‚‹

### `schema.prisma`ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± `User` ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ `RefreshToken` ã®ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚

```prisma
model User {
  id           String         @id @unique @default(uuid())
  email        String         @unique
  password     String
  refreshToken RefreshToken[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model RefreshToken {
  id          String   @id @unique @default(uuid())
  hashedToken String
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

#### `User`

- `email`ã¨`password`ã¯ç™»éŒ²ã¨ãƒ­ã‚°ã‚¤ãƒ³ã«ç”¨ã„ã‚‹ã€‚
- `refreshToken`ã‚’è¿½åŠ ã—ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ç™ºè¡Œã•ã‚ŒãŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç´ã¥ã‘ã‚‹ã€‚

#### `RefreshToken`

- `hashedToken`ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä¿å­˜ã™ã‚‹ã€‚ 
- `userId`ã¨`user`ã‚’è¿½åŠ ã—ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ãŸå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç´ã¥ã‘ã‚‹ã€‚
- `revoked`ã«ã‚ˆã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹ã€‚

#### è£œè¶³

- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç™ºè¡Œç›´å¾Œã«Cookieã‚„LocalStorageã«ä¿å­˜ã•ã‚Œã‚‹æƒ³å®šã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ä¿å­˜ã—ãªã„ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± `User` ã«é–¢é€£ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã™ã‚‹

- `findUsers` : ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒªã‚¹ãƒˆã‚’æ¤œç´¢ã™ã‚‹
- `findUserById` : ãƒ¦ãƒ¼ã‚¶ãƒ¼Idã‚’ã‚­ãƒ¼ã«ã—ã¦æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹
- `findUserByEmail` : Emailã‚’ã‚­ãƒ¼ã«ã—ã¦æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹
- `createUserByEmailAndPassword` : Emailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ–°è¦ä½œæˆã™ã‚‹
- `updateUser` : ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹
- `deleteUser` : ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± `User` ã«é–¢é€£ã™ã‚‹APIãƒ«ãƒ¼ãƒˆã‚’å®šç¾©ã™ã‚‹

Expressã§ã¯`express.Router()`ã‚’ç”¨ã„ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  
ã“ã‚Œã«ã‚ˆã£ã¦APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```typescript
const router = express.Router();

router.get("/", (req, res) => {
  res.send("Hello World!");
});
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã«é–¢ã™ã‚‹APIãƒ«ãƒ¼ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã™ã‚‹ã€‚

- GET `/users` : ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒªã‚¹ãƒˆã‚’æ¤œç´¢ã™ã‚‹
- GET `/users/:id` : ãƒ¦ãƒ¼ã‚¶ãƒ¼Idã‚’ã‚­ãƒ¼ã«ã—ã¦æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹
- POST `/users` : Emailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ–°è¦ä½œæˆã™ã‚‹
- PUT `/users/:id` : ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹
- DELETE `/users/:id` : ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹

### èªè¨¼å‡¦ç† `Auth` ã«é–¢é€£ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã™ã‚‹

- `addRefreshTokenToWhitelist` : ãƒˆãƒ¼ã‚¯ãƒ³IDã€ãƒãƒƒã‚·ãƒ¥å€¤ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…ƒã«ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ–°è¦ç™ºè¡Œã™ã‚‹
- `findRefreshToken` : ãƒˆãƒ¼ã‚¯ãƒ³Idã‚’ã‚­ãƒ¼ã«ã—ã¦æ—¢å­˜ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œç´¢ã™ã‚‹
- `deleteRefreshToken` : ãƒˆãƒ¼ã‚¯ãƒ³Idã‚’ã‚­ãƒ¼ã«ã—ã¦æ—¢å­˜ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
- `revokeTokens` : ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚­ãƒ¼ã«ã—ã¦ã€è©²å½“ã™ã‚‹ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®å‡¦ç†ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ãŸCookieã¾ãŸã¯LocalStorageã‚’æ¶ˆå»ã™ã‚Œã°ã‚ˆã„ã®ã§ã€ã‚µãƒ¼ãƒ“ã‚¹å´ã§ã¯è€ƒæ…®ã‚’ã—ãªã„ã€‚

### èªè¨¼å‡¦ç† `Auth` ã«é–¢é€£ã™ã‚‹APIãƒ«ãƒ¼ãƒˆã‚’å®šç¾©ã™ã‚‹

èªè¨¼å‡¦ç†ã«é–¢ã™ã‚‹APIãƒ«ãƒ¼ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã™ã‚‹ã€‚

- POST `/auth/register` : Emailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ–°è¦ä½œæˆã™ã‚‹
- POST `/auth/login` : Emailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
- POST `/auth/refreshtoken` : ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ–°è¦ã«ç”Ÿæˆã™ã‚‹
- POST `/auth/revoke-refresh-token` : ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

èªè¨¼å‡¦ç†ã®ãƒ«ãƒ¼ãƒˆã§ã¯PrismaClientã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œä»¥å¤–ã«ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚‚åˆã‚ã›ã¦æ¤œè¨¼ã™ã‚‹ã€‚

#### POST `/auth/register`

ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ–°è¦ä½œæˆã§ã¯ä»¥ä¸‹ã®æ‰‹é †ã«æ²¿ã£ã¦å‡¦ç†ã‚’è¡Œã†ã€‚

1. å…¥åŠ›ã•ã‚ŒãŸEmailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã€‚å…¥åŠ›å€¤ãŒä¸æ­£ãªå ´åˆã¯400ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
2. å…¥åŠ›ã•ã‚ŒãŸEmailãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯400ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ–°è¦ä½œæˆã™ã‚‹ã€‚
4. UUIDã‚’ç”¨ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã€‚
5. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã€‚
6. ç™ºè¡Œã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’APIãƒ«ãƒ¼ãƒˆå‘¼ã³å‡ºã—å…ƒã«è¿”ã™ã€‚

#### POST `/auth/login`

ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ã¯ä»¥ä¸‹ã®æ‰‹é †ã«æ²¿ã£ã¦å‡¦ç†ã‚’è¡Œã†ã€‚

1. å…¥åŠ›ã•ã‚ŒãŸEmailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã€‚å…¥åŠ›å€¤ãŒä¸æ­£ãªå ´åˆã¯400ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
2. å…¥åŠ›ã•ã‚ŒãŸEmailãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚ç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯403ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
3. å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ä¸€è‡´ã™ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚ä¸€è‡´ã—ãªã„å ´åˆã¯403ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
4. UUIDã‚’ç”¨ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã€‚
5. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã€‚
6. ç™ºè¡Œã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’APIãƒ«ãƒ¼ãƒˆå‘¼ã³å‡ºã—å…ƒã«è¿”ã™ã€‚

#### POST `/auth/refreshtoken`

ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆã¨ä¿å­˜ã¯ä»¥ä¸‹ã®æ‰‹é †ã«æ²¿ã£ã¦å‡¦ç†ã‚’è¡Œã†ã€‚

1. APIãƒ«ãƒ¼ãƒˆå‘¼ã³å‡ºã—å…ƒã‹ã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã‚‹ã€‚
2. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã€‚å…¥åŠ›å€¤ãŒä¸æ­£ãªå ´åˆã¯400ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
3. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚ç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
4. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
5. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒƒã‚·ãƒ¥å€¤ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒãƒƒã‚·ãƒ¥å€¤ã¨ä¸€è‡´ã™ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚ä¸€è‡´ã—ãªã„å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
6. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ä¸€è‡´ã™ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚ä¸€è‡´ã—ãªã„å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
7. å¤ã„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚
8. UUIDã‚’ç”¨ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ–°è¦ç™ºè¡Œã™ã‚‹ã€‚
9. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã€‚
10. ç™ºè¡Œã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’APIãƒ«ãƒ¼ãƒˆå‘¼ã³å‡ºã—å…ƒã«è¿”ã™ã€‚

#### POST `/auth/revoke-refresh-token`

ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡åŠ¹åŒ–ã¯ä»¥ä¸‹ã®æ‰‹é †ã«æ²¿ã£ã¦å‡¦ç†ã‚’è¡Œã†ã€‚

1. APIãƒ«ãƒ¼ãƒˆå‘¼ã³å‡ºã—å…ƒã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å—ã‘å–ã‚‹ã€‚
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ä¸€è‡´ã™ã‚‹æœ‰åŠ¹ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³å…¨ä»¶ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ¤œç´¢ã™ã‚‹ã€‚
3. æ¤œç´¢çµæœã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚

### èªè¨¼å‡¦ç†ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½œæˆã™ã‚‹

Expressã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã€`req`ã€`res`ã€`next`ã®3ã¤ã®å¼•æ•°ã‚’å—ã‘å–ã‚‹é–¢æ•°ã§ã‚ã‚Šã€  
ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µã‚¤ã‚¯ãƒ«ã®é€”ä¸­ã§å…±é€šã®å‡¦ç†ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã«ç”¨ã„ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```typescript
const middleware = (req, res, next) => {
  // do something
  next();
};
```

ä»Šå›ã®èªè¨¼æ©Ÿèƒ½ã§ã¯ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢`isAuthenticated`ã‚’ä½œæˆã™ã‚‹ã€‚  
`isAuthenticated`ã§ã¯ä¸»ã«ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã†ã€‚

1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³`authorization`ã‚’å–å¾—ã™ã‚‹ã€‚
2. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
3. `jsonwebtoken.verify()`ã‚’ç”¨ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ã€‚æœ‰åŠ¹ã§ãªã„å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
4. æœ‰åŠ¹ãªå ´åˆã¯`next()`ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ—ãƒ­ã‚»ã‚¹ã®æ¬¡ã®å‡¦ç†ã«é€²ã‚€ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã€‚

```typescript
import { NextFunction, Request, Response } from "express";
import { TokenExpiredError, verify } from "jsonwebtoken";
import { env } from "./env";

export const isAuthenticated = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const { authorization } = req.headers;

  if (!authorization) {
    res.status(401);
    throw new Error("ğŸš« Un-Authorized ğŸš«");
  }

  try {
    const token = authorization.split(" ")[1];

    verify(token, env.JWT_ACCESS_SECRET);
  } catch (err) {
    res.status(401);
    if (err instanceof TokenExpiredError) {
      throw new Error(err.name);
    }
    throw new Error("ğŸš« Un-Authorized ğŸš«");
  }

  return next();
};
```

## è£œè¶³

- ç’°å¢ƒå¤‰æ•°ã®å‹ã‚’å®šç¾©ã™ã‚‹

### ç’°å¢ƒå¤‰æ•°ã®å‹ã‚’å®šç¾©ã™ã‚‹

æœ¬ä»¶ã§ã¯å°‘ãªãã¨ã‚‚ä»¥ä¸‹3ä»¶ã®ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã€‚

- `DATABASE_URL`
- `JWT_ACCESS_SECRET`
- `JWT_REFRESH_SECRET`

ã“ã‚Œã‚‰ã¯ã™ã¹ã¦`string`å‹ã¨ã—ã¦æ‰±ã†ã“ã¨ã«ãªã‚‹ãŒã€ãã®ã¾ã¾èª­ã¿è¾¼ã‚€ã¨å‹ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã«ãªã‚‹ã€‚  
ã“ã‚Œã‚‰ã«å‹ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”¨ã„ã‚‹ã€‚

| Module | Usage |
| --- | --- |
| [@t3-oss/env-core](https://github.com/t3-oss/t3-env) | `createEnv`é–¢æ•°ã§å‹ä»˜ã‘ã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã‚’è¿”ã™ã€‚ |
| [dotenv](https://github.com/motdotla/dotenv) | `config`é–¢æ•°ã§`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚ |
| [zod](https://github.com/colinhacks/zod) | ã‚¹ã‚­ãƒ¼ãƒå®£è¨€ãƒ»ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ã“ã“ã§ã¯ç’°å¢ƒå¤‰æ•°ã®ã‚¹ã‚­ãƒ¼ãƒå®£è¨€ã«ç”¨ã„ã‚‹ã€‚ |

å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«TypeScriptã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã€ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹å‘¼ã³å‡ºã—å…ƒã§importã—ã¦ä½¿ç”¨ã™ã‚‹ã€‚

```typescript
import { createEnv } from "@t3-oss/env-core";
import { config } from "dotenv";
import { z } from "zod";

config();

export const env = createEnv({
  server: {
    DATABASE_URL: z.string().url(),
    JWT_ACCESS_SECRET: z.string(),
    JWT_REFRESH_SECRET: z.string(),
  },
  runtimeEnv: process.env,
});
```